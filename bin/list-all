#!/usr/bin/env bash

set -euo pipefail

# Get the plugin directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source utility functions
# shellcheck source=../lib/utils.sh
source "${PLUGIN_DIR}/lib/utils.sh"

# List all available ghjk versions from GitHub releases
list_all_versions() {
  local releases_json
  local versions
  local page=1
  local per_page=100
  local all_versions=()

  # Fetch all release pages (GitHub API paginates at 100 items)
  while true; do
    releases_json="$(github_api_fetch "${GITHUB_API_URL}/releases?per_page=${per_page}&page=${page}")"

    if [[ -z "$releases_json" ]] || [[ "$releases_json" == "[]" ]]; then
      break
    fi

    # Extract version tags from releases
    # Filter out drafts and get tag names
    versions="$(echo "$releases_json" | grep -o '"tag_name": *"[^"]*"' | sed 's/"tag_name": *"\([^"]*\)"/\1/' || true)"

    if [[ -z "$versions" ]]; then
      break
    fi

    # Add versions to array
    while IFS= read -r version; do
      if [[ -n "$version" ]]; then
        all_versions+=("$version")
      fi
    done <<< "$versions"

    # Check if we got less than per_page results (last page)
    local count
    count="$(echo "$releases_json" | grep -c '"tag_name"' || echo "0")"
    if [[ $count -lt $per_page ]]; then
      break
    fi

    page=$((page + 1))
  done

  # Output versions space-separated (asdf expects this format)
  if [[ ${#all_versions[@]} -gt 0 ]]; then
    printf '%s\n' "${all_versions[@]}" | sort_versions | tr '\n' ' '
    echo
  else
    error "No versions found"
    exit 1
  fi
}

# Main execution
main() {
  check_dependencies
  list_all_versions
}

main "$@"
