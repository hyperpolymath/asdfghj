#!/usr/bin/env bash

set -euo pipefail

# Get the plugin directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source utility functions
# shellcheck source=../lib/utils.sh
source "${PLUGIN_DIR}/lib/utils.sh"

# Install ghjk from downloaded archive
install_version() {
  local version="$1"
  local install_path="$2"
  local download_path="$3"
  local metadata_file="${download_path}/.metadata"
  local archive_name
  local archive_path

  log "Installing ghjk ${version}..."

  # Read metadata from download script
  if [[ -f "$metadata_file" ]]; then
    # shellcheck source=/dev/null
    source "$metadata_file"
    archive_path="${download_path}/${archive}"
  else
    # Fallback: try to detect archive
    archive_name="$(get_asset_name "$version" "$(get_platform)")"
    archive_path="${download_path}/${archive_name}"
  fi

  if [[ ! -f "$archive_path" ]]; then
    error "Archive not found: $archive_path"
    error "Run 'asdf download ghjk ${version}' first"
    exit 1
  fi

  # Extract archive to install path
  if ! extract_archive "$archive_path" "$install_path"; then
    error "Failed to extract ghjk ${version}"
    exit 1
  fi

  # Verify the ghjk binary exists and is executable
  local ghjk_bin="${install_path}/ghjk"

  if [[ ! -f "$ghjk_bin" ]]; then
    error "ghjk binary not found after extraction"
    error "Expected location: $ghjk_bin"
    error "Archive contents:"
    ls -la "$install_path" >&2
    exit 1
  fi

  # Make binary executable
  chmod +x "$ghjk_bin"

  # Verify the installation by running version check
  log "Verifying installation..."
  if "$ghjk_bin" --version &>/dev/null; then
    local installed_version
    installed_version="$("$ghjk_bin" --version 2>&1 | head -n1 || echo "unknown")"
    success "Successfully installed ghjk ${version}"
    log "Installed version output: ${installed_version}"
  else
    warn "Installation completed but version check failed"
    warn "This may be normal for some versions"
  fi

  # Check for required runtime dependencies
  log "Checking ghjk runtime dependencies..."
  local missing_runtime_deps=()

  for dep in git tar curl unzip zstd; do
    if ! command_exists "$dep"; then
      missing_runtime_deps+=("$dep")
    fi
  done

  if [[ ${#missing_runtime_deps[@]} -gt 0 ]]; then
    warn "Missing recommended runtime dependencies: ${missing_runtime_deps[*]}"
    warn "ghjk may not function correctly without these tools"
    warn "Please install them for full functionality"
  else
    success "All runtime dependencies are available"
  fi

  # Create shims directory if it doesn't exist
  mkdir -p "${install_path}/bin"

  # If ghjk is not in bin/, create a symlink
  if [[ ! -f "${install_path}/bin/ghjk" ]] && [[ -f "$ghjk_bin" ]]; then
    ln -s "../ghjk" "${install_path}/bin/ghjk"
    log "Created bin/ghjk symlink"
  fi

  success "ghjk ${version} installed at ${install_path}"
}

# Main execution
main() {
  local install_type="${ASDF_INSTALL_TYPE:-version}"
  local version="${ASDF_INSTALL_VERSION:-}"
  local install_path="${ASDF_INSTALL_PATH:-}"
  local download_path="${ASDF_DOWNLOAD_PATH:-}"

  if [[ -z "$version" ]]; then
    error "ASDF_INSTALL_VERSION environment variable is required"
    exit 1
  fi

  if [[ -z "$install_path" ]]; then
    error "ASDF_INSTALL_PATH environment variable is required"
    exit 1
  fi

  if [[ "$install_type" != "version" ]]; then
    error "This plugin only supports installing specific versions"
    error "Install type '${install_type}' is not supported"
    error "Use: asdf install ghjk <version>"
    exit 1
  fi

  check_dependencies
  install_version "$version" "$install_path" "$download_path"
}

main "$@"
